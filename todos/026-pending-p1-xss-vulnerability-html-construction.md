---
status: pending
priority: p1
issue_id: "026"
tags: [code-review, security, critical, xss]
dependencies: []
---

# XSS Vulnerability in HTML Email Body Construction

## Problem Statement

**HIGH SECURITY ISSUE**: The code constructs HTML by directly wrapping AI-generated content in `<p>` tags without HTML escaping. This creates a **Stored XSS vulnerability** where malicious AI output can inject JavaScript into emails.

## Findings

### From Security Sentinel Agent:

**Evidence from `/email-workflow/app/api/compose/save/route.ts` (Lines 70-76):**
```typescript
const htmlBody = draftBody
  .split('\n')
  .map((line) => line.trim())
  .filter((line) => line.length > 0)
  .map((line) => `<p>${line}</p>`)  // ‚ùå NO HTML ESCAPING
  .join('');
```

**Attack Scenario:**
1. Attacker crafts instructions that trick the AI into outputting: `<img src=x onerror=alert('XSS')>`
2. This gets wrapped as: `<p><img src=x onerror=alert('XSS')></p>`
3. When the email is rendered in Gmail or other clients, the script executes

**Impact:**
- **Session Hijacking**: Steal email account credentials
- **Phishing**: Inject malicious links into drafts
- **Data Exfiltration**: Extract sensitive email data

## Proposed Solutions

### Solution 1: HTML Entity Encoding (Recommended)
**Pros:**
- Simple, no dependencies
- Fast performance
- Complete XSS protection

**Cons:**
- Manual escaping prone to errors
- Need to maintain escape function

**Effort**: Low (1 hour)
**Risk**: Low - standard security practice

**Implementation:**
```typescript
function htmlEscape(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

const htmlBody = draftBody
  .split('\n')
  .map((line) => line.trim())
  .filter((line) => line.length > 0)
  .map((line) => `<p>${htmlEscape(line)}</p>`)
  .join('');
```

### Solution 2: DOMPurify Sanitization
**Pros:**
- Industry-standard library
- Handles complex HTML
- Allows safe subset of tags

**Cons:**
- Adds dependency (isomorphic-dompurify)
- Slightly slower than entity encoding
- Overkill for plain text

**Effort**: Low (1 hour)
**Risk**: Low - well-tested library

**Implementation:**
```typescript
import DOMPurify from 'isomorphic-dompurify';

const htmlBody = DOMPurify.sanitize(draftBody, {
  ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u'],
  ALLOWED_ATTR: []
});
```

### Solution 3: Use Plain Text Instead
**Pros:**
- Zero XSS risk
- Simpler code
- Faster

**Cons:**
- No formatting support
- Gmail might render differently

**Effort**: Very Low (15 minutes)
**Risk**: Low - safest option

**Implementation:**
```typescript
// Just send plain text, let Gmail handle rendering
body: draftBody,  // No HTML conversion at all
```

## Recommended Action

**Use Solution 1** (HTML Entity Encoding) because:
1. Provides complete XSS protection
2. No external dependencies
3. Preserves paragraph structure
4. Simple to test and verify

Add DOMPurify later if rich formatting is needed.

## Technical Details

**Affected Files:**
- `/email-workflow/app/api/compose/save/route.ts` lines 70-76

**Current Code:**
```typescript
const htmlBody = draftBody
  .split('\n')
  .map((line) => line.trim())
  .filter((line) => line.length > 0)
  .map((line) => `<p>${line}</p>`)  // VULNERABLE
  .join('');
```

**Fixed Code:**
```typescript
function htmlEscape(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

const htmlBody = draftBody
  .split('\n')
  .map((line) => line.trim())
  .filter((line) => line.length > 0)
  .map((line) => `<p>${htmlEscape(line)}</p>`)
  .join('');
```

## Acceptance Criteria

- [ ] All HTML construction uses proper escaping
- [ ] Test with XSS payloads (`<script>alert('XSS')</script>`)
- [ ] Test with HTML entities (`&lt;`, `&gt;`, `&amp;`)
- [ ] Test with special chars (`"`, `'`, `<`, `>`)
- [ ] Gmail renders emails correctly without script execution
- [ ] Unit tests added for XSS protection

## Work Log

**2026-01-11**: Issue identified during code review by security-sentinel agent

## Resources

- **PR**: #79 - feat: Add AI-powered compose email feature
- **Review Agent**: security-sentinel
- **OWASP Category**: A03 - Injection (XSS)
- **Severity**: HIGH - Must fix before merge
- **Similar Issue**: Also found in frontend (ComposeForm.tsx) but React auto-escapes
